{
  "version": 3,
  "sources": ["../../../src/cryptography/keypair.ts"],
  "sourcesContent": ["import { toB64 } from '@mgonetwork/bcs';\nimport { keccak_256 } from '@noble/hashes/sha3';\nimport { bech32 } from 'bech32';\n\nimport { bcs } from '../bcs/index.js';\nimport { IntentScope, messageWithIntent } from './intent.js';\nimport type { PublicKey } from './publickey.js';\nimport type { SignatureScheme } from './signature-scheme.js';\nimport { SIGNATURE_FLAG_TO_SCHEME, SIGNATURE_SCHEME_TO_FLAG } from './signature-scheme.js';\nimport type { SerializedSignature } from './signature.js';\nimport { toSerializedSignature } from './signature.js';\n\nexport const PRIVATE_KEY_SIZE = 32;\nexport const LEGACY_PRIVATE_KEY_SIZE = 64;\nexport const MGO_PRIVATE_KEY_PREFIX = 'mgoprivkey';\n\nexport type ParsedKeypair = {\n\tschema: SignatureScheme;\n\tsecretKey: Uint8Array;\n};\n\n/** @deprecated use string instead. See {@link Keypair.getSecretKey} */\nexport type ExportedKeypair = {\n\tschema: SignatureScheme;\n\tprivateKey: string;\n};\n\nexport interface SignatureWithBytes {\n\tbytes: string;\n\tsignature: SerializedSignature;\n}\n\n/**\n * TODO: Document\n */\nexport abstract class BaseSigner {\n\tabstract sign(bytes: Uint8Array): Promise<Uint8Array>;\n\t/**\n\t * Sign messages with a specific intent. By combining the message bytes with the intent before hashing and signing,\n\t * it ensures that a signed message is tied to a specific purpose and domain separator is provided\n\t */\n\tasync signWithIntent(bytes: Uint8Array, intent: IntentScope): Promise<SignatureWithBytes> {\n\t\tconst intentMessage = messageWithIntent(intent, bytes);\n\t\tconst digest = keccak_256(intentMessage);\n\n\t\tconst signature = toSerializedSignature({\n\t\t\tsignature: await this.sign(digest),\n\t\t\tsignatureScheme: this.getKeyScheme(),\n\t\t\tpublicKey: this.getPublicKey(),\n\t\t});\n\n\t\treturn {\n\t\t\tsignature,\n\t\t\tbytes: toB64(bytes),\n\t\t};\n\t}\n\t/**\n\t * Signs provided transaction block by calling `signWithIntent()` with a `TransactionData` provided as intent scope\n\t */\n\tasync signTransactionBlock(bytes: Uint8Array) {\n\t\treturn this.signWithIntent(bytes, IntentScope.TransactionData);\n\t}\n\t/**\n\t * Signs provided personal message by calling `signWithIntent()` with a `PersonalMessage` provided as intent scope\n\t */\n\tasync signPersonalMessage(bytes: Uint8Array) {\n\t\treturn this.signWithIntent(\n\t\t\tbcs.ser(['vector', 'u8'], bytes).toBytes(),\n\t\t\tIntentScope.PersonalMessage,\n\t\t);\n\t}\n\n\t/**\n\t * @deprecated use `signPersonalMessage` instead\n\t */\n\tasync signMessage(bytes: Uint8Array) {\n\t\treturn this.signPersonalMessage(bytes);\n\t}\n\n\ttoMgoAddress(): string {\n\t\treturn this.getPublicKey().toMgoAddress();\n\t}\n\n\t/**\n\t * Return the signature for the data.\n\t * Prefer the async version {@link sign}, as this method will be deprecated in a future release.\n\t */\n\tabstract signData(data: Uint8Array): Uint8Array;\n\n\t/**\n\t * Get the key scheme of the keypair: Secp256k1 or ED25519\n\t */\n\tabstract getKeyScheme(): SignatureScheme;\n\n\t/**\n\t * The public key for this keypair\n\t */\n\tabstract getPublicKey(): PublicKey;\n}\n\n/**\n * TODO: Document\n */\nexport abstract class Keypair extends BaseSigner {\n\t/**\n\t * This returns the Bech32 secret key string for this keypair.\n\t */\n\tabstract getSecretKey(): string;\n\n\tabstract export(): ExportedKeypair;\n}\n\n/**\n * This returns an ParsedKeypair object based by validating the\n * 33-byte Bech32 encoded string starting with `mgoprivkey`, and\n * parse out the signature scheme and the private key in bytes.\n */\nexport function decodeMgoPrivateKey(value: string): ParsedKeypair {\n\tconst { prefix, words } = bech32.decode(value);\n\tif (prefix !== MGO_PRIVATE_KEY_PREFIX) {\n\t\tthrow new Error('invalid private key prefix');\n\t}\n\tconst extendedSecretKey = new Uint8Array(bech32.fromWords(words));\n\tconst secretKey = extendedSecretKey.slice(1);\n\tconst signatureScheme =\n\t\tSIGNATURE_FLAG_TO_SCHEME[extendedSecretKey[0] as keyof typeof SIGNATURE_FLAG_TO_SCHEME];\n\treturn {\n\t\tschema: signatureScheme,\n\t\tsecretKey: secretKey,\n\t};\n}\n\n/**\n * This returns a Bech32 encoded string starting with `mgoprivkey`,\n * encoding 33-byte `flag || bytes` for the given the 32-byte private\n * key and its signature scheme.\n */\nexport function encodeMgoPrivateKey(bytes: Uint8Array, scheme: SignatureScheme): string {\n\tif (bytes.length !== PRIVATE_KEY_SIZE) {\n\t\tthrow new Error('Invalid bytes length');\n\t}\n\tconst flag = SIGNATURE_SCHEME_TO_FLAG[scheme];\n\tconst privKeyBytes = new Uint8Array(bytes.length + 1);\n\tprivKeyBytes.set([flag]);\n\tprivKeyBytes.set(bytes, 1);\n\treturn bech32.encode(MGO_PRIVATE_KEY_PREFIX, bech32.toWords(privKeyBytes));\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,iBAAsB;AACtB,kBAA2B;AAC3B,oBAAuB;AAEvB,IAAAA,cAAoB;AACpB,oBAA+C;AAG/C,8BAAmE;AAEnE,uBAAsC;AAE/B,MAAM,mBAAmB;AACzB,MAAM,0BAA0B;AAChC,MAAM,yBAAyB;AAqB/B,MAAe,WAAW;AAAA;AAAA;AAAA;AAAA;AAAA,EAMhC,MAAM,eAAe,OAAmB,QAAkD;AACzF,UAAM,oBAAgB,iCAAkB,QAAQ,KAAK;AACrD,UAAM,aAAS,wBAAW,aAAa;AAEvC,UAAM,gBAAY,wCAAsB;AAAA,MACvC,WAAW,MAAM,KAAK,KAAK,MAAM;AAAA,MACjC,iBAAiB,KAAK,aAAa;AAAA,MACnC,WAAW,KAAK,aAAa;AAAA,IAC9B,CAAC;AAED,WAAO;AAAA,MACN;AAAA,MACA,WAAO,kBAAM,KAAK;AAAA,IACnB;AAAA,EACD;AAAA;AAAA;AAAA;AAAA,EAIA,MAAM,qBAAqB,OAAmB;AAC7C,WAAO,KAAK,eAAe,OAAO,0BAAY,eAAe;AAAA,EAC9D;AAAA;AAAA;AAAA;AAAA,EAIA,MAAM,oBAAoB,OAAmB;AAC5C,WAAO,KAAK;AAAA,MACX,gBAAI,IAAI,CAAC,UAAU,IAAI,GAAG,KAAK,EAAE,QAAQ;AAAA,MACzC,0BAAY;AAAA,IACb;AAAA,EACD;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,YAAY,OAAmB;AACpC,WAAO,KAAK,oBAAoB,KAAK;AAAA,EACtC;AAAA,EAEA,eAAuB;AACtB,WAAO,KAAK,aAAa,EAAE,aAAa;AAAA,EACzC;AAiBD;AAKO,MAAe,gBAAgB,WAAW;AAOjD;AAOO,SAAS,oBAAoB,OAA8B;AACjE,QAAM,EAAE,QAAQ,MAAM,IAAI,qBAAO,OAAO,KAAK;AAC7C,MAAI,WAAW,wBAAwB;AACtC,UAAM,IAAI,MAAM,4BAA4B;AAAA,EAC7C;AACA,QAAM,oBAAoB,IAAI,WAAW,qBAAO,UAAU,KAAK,CAAC;AAChE,QAAM,YAAY,kBAAkB,MAAM,CAAC;AAC3C,QAAM,kBACL,iDAAyB,kBAAkB,CAAC,CAA0C;AACvF,SAAO;AAAA,IACN,QAAQ;AAAA,IACR;AAAA,EACD;AACD;AAOO,SAAS,oBAAoB,OAAmB,QAAiC;AACvF,MAAI,MAAM,WAAW,kBAAkB;AACtC,UAAM,IAAI,MAAM,sBAAsB;AAAA,EACvC;AACA,QAAM,OAAO,iDAAyB,MAAM;AAC5C,QAAM,eAAe,IAAI,WAAW,MAAM,SAAS,CAAC;AACpD,eAAa,IAAI,CAAC,IAAI,CAAC;AACvB,eAAa,IAAI,OAAO,CAAC;AACzB,SAAO,qBAAO,OAAO,wBAAwB,qBAAO,QAAQ,YAAY,CAAC;AAC1E;",
  "names": ["import_bcs"]
}
