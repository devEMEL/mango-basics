import { keccak_256 } from '@noble/hashes/sha3';

import type { MgoClient } from '../client/index.js';
import type { Keypair } from '../cryptography/keypair.js';
import { toSerializedSignature } from '../cryptography/signature.js';
import type { SerializedSignature } from '../cryptography/signature.js';
import type { JsonRpcProvider } from '../providers/json-rpc-provider.js';
import { SignerWithProvider } from './signer-with-provider.js';

export class RawSigner extends SignerWithProvider {
	private readonly keypair: Keypair;

	constructor(keypair: Keypair, client: JsonRpcProvider | MgoClient) {
		super(client);
		this.keypair = keypair;
	}

	async getAddress(): Promise<string> {
		return this.keypair.getPublicKey().toMgoAddress();
	}

	async signData(data: Uint8Array): Promise<SerializedSignature> {
		const publicKey = this.keypair.getPublicKey();
		const digest = keccak_256(data);
		const signature = this.keypair.signData(digest);
		const signatureScheme = this.keypair.getKeyScheme();

		return toSerializedSignature({
			signatureScheme,
			signature,
			publicKey,
		});
	}

	connect(client: MgoClient | JsonRpcProvider): SignerWithProvider {
		return new RawSigner(this.keypair, client);
	}
}
